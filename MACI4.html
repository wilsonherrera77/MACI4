<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MACI – Componente 4: Capacidades en Genética y Biobanco</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
  <style>
    :root { --ink:#073B4C; --green:#06D6A0; --blue:#118AB2; --amber:#FFD166; --orange:#E67E22; --violet:#8E44AD; --emerald:#27AE60; --rose:#FF6B6B; --gray:#A3A3A3; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f8f9fa; }
    .card { background:#fff; border-radius:0.75rem; box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05); padding:1.25rem }
    .card:hover{ transform:translateY(-2px); transition:transform .2s ease }
    .chart-container{ position:relative; width:100%; height:360px }
    @media (min-width: 768px){ .chart-container{ height:420px } }
    .badge{ display:inline-block; padding:.25rem .5rem; border-radius:.5rem; background:#F3F4F6; font-weight:600; font-size:.85rem }
  </style>
</head>
<body class="text-gray-800">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <header class="mb-8 md:mb-12 text-center">
      <p class="uppercase tracking-widest text-xs text-gray-500">Programa MACI – Infografía por Componente</p>
      <h1 class="text-3xl md:text-5xl font-black text-[var(--ink)]">Componente 4: Capacidades en Genética y Biobanco</h1>
      <p class="mt-2 text-base md:text-lg text-gray-600 max-w-3xl mx-auto">Pilotos de secuenciación y <strong>biobanco piloto</strong> con cadena de custodia, cumplimiento ético/CLPI y acuerdos <strong>ABS</strong>, con análisis bioinformático reproducible.</p>

      <!-- Imagen interactiva (se inserta justo después de los títulos) -->
      <!-- Se usa la URL RAW para asegurar carga del PNG -->
      <div class="mt-6 flex justify-center">
        <img id="biopirateriaImg"
             src="https://raw.githubusercontent.com/wilsonherrera77/MACI/main/Biopirateria.png"
             alt="Biopiratería"
             class="cursor-pointer max-w-full rounded-lg shadow-lg transition-all duration-300 hover:scale-105"/>
      </div>
    </header>

    <!-- Overlay pantalla completa -->
    <div id="imgOverlay"
         class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden cursor-pointer">
      <img id="overlayImg" src="" alt="Imagen ampliada" class="max-w-full max-h-full rounded-lg shadow-2xl"/>
    </div>

    <!-- Objetivo e Indicadores -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-8">
      <div class="card lg:col-span-2">
        <h2 class="text-xl md:text-2xl font-bold text-[var(--ink)] mb-2">Objetivo específico</h2>
        <p class="text-gray-700">Desarrollar <strong>pilotos de secuenciación</strong> y un <strong>biobanco piloto</strong> con SOPs, inventario digital y cadena de custodia; asegurando <strong>ética, CLPI y ABS</strong>, y manejo responsable de <strong>DSI</strong>.</p>
        <ul class="mt-3 text-sm text-gray-700 list-disc list-inside">
          <li><strong>Entregables:</strong> SOPs de laboratorio/biobanco; manual de cadena de custodia; <em>pipelines</em> bioinformáticos; acuerdos ABS/CLPI; plan de bioseguridad y riesgos.</li>
          <li><strong>Alcance:</strong> Adecuación de laboratorio o alianzas con centros; interoperabilidad con estándares <strong>GGBN/ISBER</strong> y la PSB del programa.</li>
        </ul>
      </div>
      <div class="card">
        <h3 class="text-lg font-bold text-[var(--ink)] mb-2">Indicadores a 5 años</h3>
        <ul class="space-y-2 text-sm">
          <li><span class="badge">Biobanco piloto operativo</span></li>
          <li><span class="badge">≥2 pilotos (metabarcoding / genómica)</span></li>
          <li><span class="badge">≥10 acuerdos ABS/CLPI</span></li>
          <li><span class="badge">≥90% integridad de muestras</span></li>
        </ul>
      </div>
    </section>

    <!-- Diseño operativo -->
    <section class="card mb-8">
      <h2 class="text-xl md:text-2xl font-bold text-[var(--ink)] mb-2">Diseño operativo y herramientas</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700">
        <div>
          <h4 class="font-semibold mb-1">Actividades</h4>
          <ul class="list-disc list-inside space-y-1">
            <li>Adecuación de laboratorio y/o alianzas con centros.</li>
            <li>Pilotos con secuenciación portátil y/o de alto rendimiento.</li>
            <li>Implementación del biobanco (recepción, almacenamiento, ULT, inventario digital).</li>
            <li>Formación en ABS/ética, CLPI y manejo de DSI.</li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold mb-1">Herramientas/estándares</h4>
          <ul class="list-disc list-inside space-y-1">
            <li>Secuenciación: <strong>MinION/Illumina</strong>.</li>
            <li>Bioinformática: <strong>nf-core / Galaxy</strong>.</li>
            <li>Biobanco/estándares: <strong>GGBN</strong>, buenas prácticas <strong>ISBER</strong>.</li>
            <li>Lineamientos: <strong>ABS</strong> y CLPI.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Presupuesto año 1 y controles -->
    <section class="card mb-8">
      <h2 class="text-xl md:text-2xl font-bold text-[var(--ink)] mb-2">Presupuesto (Año 1) y Fases</h2>
      <p class="text-sm text-gray-600 mb-3">Total de referencia <strong>USD 1.268.000</strong>. Desglose exacto provisto por el programa. Ajusta TRM, moneda, % por rubro, factores 5 años y decide si sumar <em>overhead</em> 10% a este componente.</p>

      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <div class="bg-gray-50 rounded-lg p-3">
          <div class="text-xs text-gray-500">Moneda</div>
          <div class="flex items-center gap-3 mt-1 mb-2">
            <label class="inline-flex items-center gap-2"><input type="radio" name="currency" value="USD" checked class="accent-[var(--ink)]"><span>USD</span></label>
            <label class="inline-flex items-center gap-2"><input type="radio" name="currency" value="COP" class="accent-[var(--ink)]"><span>COP</span></label>
          </div>
          <label class="block text-xs text-gray-500">TRM (COP/USD)</label>
          <input id="trm" type="number" step="0.01" value="4200" class="mt-1 w-full border rounded-md px-3 py-1.5" />

          <label class="block text-xs text-gray-500 mt-3">Presupuesto Año 1</label>
          <input id="y1budget" type="number" step="100" value="1268000" class="mt-1 w-full border rounded-md px-3 py-1.5" />
          <div class="mt-2 flex items-center gap-2 text-sm">
            <input id="inclOVR" type="checkbox" class="accent-[var(--ink)]" />
            <label for="inclOVR">Añadir Overhead 10% a este componente</label>
          </div>
          <p class="text-xs text-gray-500 mt-2">Total actual: <span id="y1total" class="font-semibold">—</span></p>
        </div>

        <div class="lg:col-span-3">
          <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-xs font-semibold">Personal núcleo</div>
              <input data-pct key="personal" type="number" value="70.98" class="mt-1 w-full border rounded px-2 py-1" />
              <div class="text-[11px] text-gray-500">USD 900.000</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-xs font-semibold">Equipamiento esencial</div>
              <input data-pct key="equipamiento" type="number" value="15.77" class="mt-1 w-full border rounded px-2 py-1" />
              <div class="text-[11px] text-gray-500">USD 200.000</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-xs font-semibold">Consumibles y reactivos</div>
              <input data-pct key="consumibles" type="number" value="4.73" class="mt-1 w-full border rounded px-2 py-1" />
              <div class="text-[11px] text-gray-500">USD 60.000</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-xs font-semibold">Flujos de secuenciación</div>
              <input data-pct key="flujos" type="number" value="3.94" class="mt-1 w-full border rounded px-2 py-1" />
              <div class="text-[11px] text-gray-500">USD 50.000</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-xs font-semibold">Cadena de frío y transporte</div>
              <input data-pct key="cadena" type="number" value="1.26" class="mt-1 w-full border rounded px-2 py-1" />
              <div class="text-[11px] text-gray-500">USD 16.000</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-xs font-semibold">Arriendo y seguridad</div>
              <input data-pct key="arriendo" type="number" value="3.31" class="mt-1 w-full border rounded px-2 py-1" />
              <div class="text-[11px] text-gray-500">USD 42.000</div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div class="chart-container"><canvas id="donut"></canvas></div>
            <div class="chart-container"><canvas id="line"></canvas></div>
          </div>

          <div class="flex items-center gap-3 mt-3">
            <label class="text-sm inline-flex items-center gap-2">Factores anuales (x Año 1):</label>
            <input id="factors" type="text" value="1,0|1,2|1,3|1,4|1,45" class="flex-1 border rounded px-2 py-1 text-sm" />
            <button id="apply" class="bg-[var(--ink)] text-white rounded px-3 py-2 text-sm">Aplicar</button>
            <button id="dl1" class="underline text-[var(--blue)] text-sm">Descargar donut</button>
            <button id="dl2" class="underline text-[var(--blue)] text-sm">Descargar curva</button>
          </div>
        </div>
      </div>

      <div class="mt-4 text-xs text-gray-600">
        <p><strong>Desglose orientativo (USD):</strong> Personal 900.000; Equipamiento 200.000; Consumibles 60.000; Flujos 50.000; Cadena de frío 16.000; Arriendo/seguridad 42.000 → <strong>Total 1.268.000</strong>.</p>
        <p class="mt-1">Nota: por defecto <em>no</em> incluye overhead (10%) para evitar doble contabilización a nivel del programa. Usa el switch si deseas incorporarlo <em>en este componente</em>.</p>
      </div>
    </section>

    <!-- Equipo -->
    <section class="card mb-8">
      <h2 class="text-xl md:text-2xl font-bold text-[var(--ink)] mb-2">Equipo sugerido</h2>
      <div class="overflow-x-auto">
        <table class="w-full min-w-[760px] text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2">Rol</th>
              <th>Jornada</th>
              <th>Funciones clave</th>
            </tr>
          </thead>
          <tbody class="align-top">
            <tr class="border-b"><td class="py-2 font-semibold">Genetista/molecular</td><td>TC</td><td>Diseño experimental; supervisión de secuenciación; validación de resultados.</td></tr>
            <tr class="border-b"><td class="py-2 font-semibold">Bioinformático(a)</td><td>TP/TC</td><td>Diseño y operación de <em>pipelines</em> reproducibles; gestión de datos y trazabilidad.</td></tr>
            <tr class="border-b"><td class="py-2 font-semibold">Técnico(a) de laboratorio/biobanco</td><td>TC</td><td>Recepción, procesamiento, almacenamiento y registro de muestras.</td></tr>
            <tr class="border-b"><td class="py-2 font-semibold">Oficial de bioseguridad</td><td>TP</td><td>Plan de bioseguridad, gestión de riesgos y cumplimiento.</td></tr>
            <tr><td class="py-2 font-semibold">Gestor(a) ABS/ética</td><td>TP</td><td>CLPI, acuerdos ABS, devolución de beneficios y auditorías.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Cronograma del componente -->
    <section class="card mb-8">
      <h2 class="text-xl md:text-2xl font-bold text-[var(--ink)] mb-2">Cronograma estratégico (5 años)</h2>
      <div class="overflow-x-auto">
        <table class="w-full min-w-[760px] text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2">Actividad clave</th>
              <th>Año 1</th><th>Año 2</th><th>Año 3</th><th>Año 4</th><th>Año 5</th>
            </tr>
          </thead>
          <tbody>
            <tr class="border-b">
              <td class="py-2">Infraestructura de laboratorio/alianzas y SOPs</td>
              <td><div class="h-3 rounded-full bg-[var(--violet)]"></div></td>
              <td><div class="h-3 rounded-full bg-[color:rgba(142,68,173,.5)]"></div></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr class="border-b">
              <td class="py-2">Pilotos de secuenciación (metabarcoding/poblaciones)</td>
              <td></td>
              <td><div class="h-3 rounded-full bg-[var(--violet)]"></div></td>
              <td><div class="h-3 rounded-full bg-[var(--violet)]"></div></td>
              <td><div class="h-3 rounded-full bg-[color:rgba(142,68,173,.5)]"></div></td>
              <td></td>
            </tr>
            <tr>
              <td class="py-2">Biobanco piloto operativo y optimización</td>
              <td></td>
              <td></td>
              <td><div class="h-3 rounded-full bg-[var(--violet)]"></div></td>
              <td><div class="h-3 rounded-full bg-[var(--violet)]"></div></td>
              <td><div class="h-3 rounded-full bg-[color:rgba(142,68,173,.5)]"></div></td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Riesgos -->
    <section class="card mb-10">
      <h2 class="text-xl md:text-2xl font-bold text-[var(--ink)] mb-2">Riesgos y mitigaciones</h2>
      <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
        <li>Cumplimiento regulatorio → matriz normativa y auditorías.</li>
        <li>Sensibilidad cultural → CLPI robusto y devolución de beneficios.</li>
        <li>Sostenibilidad operativa → alianzas académicas y modelos de costo-recuperación.</li>
      </ul>
    </section>

    <footer class="text-center text-xs text-gray-500 mt-6">
      <p>Plantilla dinámica – exporta los gráficos con los botones sobre cada lienzo. Ajusta TRM y porcentajes según negociación.</p>
    </footer>
  </div>

  <script>
    /************ LÓGICA DE LA IMAGEN INTERACTIVA ************/
    (function(){
      const img = document.getElementById('biopirateriaImg');
      const overlay = document.getElementById('imgOverlay');
      const overlayImg = document.getElementById('overlayImg');
      const targetURL = "https://wilsonherrera77.github.io/MACI_Biopirateria/MACI_BIOPIRATERIA.html";
      let expanded = false;

      if (img && overlay && overlayImg) {
        img.addEventListener('click', function(){
          if (!expanded) {
            overlayImg.src = img.src; // mostrar la misma imagen
            overlay.classList.remove('hidden'); // primera interacción: ampliar
            expanded = true;
          }
        });

        // segunda interacción: navegar al enlace
        overlay.addEventListener('click', function(){
          if (expanded) {
            window.location.href = targetURL;
          }
        });

        // ESC para cerrar y volver a la infografía sin navegar
        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape' && expanded) {
            overlay.classList.add('hidden');
            expanded = false;
          }
        });
      }
    })();

    /************ UTILIDADES ************/
    const qs = (sel, el=document) => el.querySelector(sel);
    const qsa = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const fmt = (val, currency, trm) => new Intl.NumberFormat('es-CO', { style:'currency', currency: currency==='USD'?'USD':'COP', maximumFractionDigits:0 }).format(currency==='USD'?val:val*trm);

    /************ ESTADO ************/
    let currency = 'USD';
    let trm = 4200;
    let year1 = 1268000; // Año 1 referencia (Genética)
    let pct = { personal:70.98, equipamiento:15.77, consumibles:4.73, flujos:3.94, cadena:1.26, arriendo:3.31 }; // % dentro del Año 1
    let factors = [1.0, 1.2, 1.3, 1.4, 1.45];
    let addOverhead = false; // 10%

    /************ CHARTS ************/
    const donutCtx = document.getElementById('donut').getContext('2d');
    const lineCtx  = document.getElementById('line').getContext('2d');
    let donut, line;

    function getBreakdown(){
      const totalPct = Object.values(pct).reduce((a,b)=>a+Number(b||0),0) || 1;
      const keys = ['personal','equipamiento','consumibles','flujos','cadena','arriendo'];
      const labels = ['Personal núcleo','Equipamiento esencial','Consumibles y reactivos','Flujos de secuenciación','Cadena de frío y transporte','Arriendo y seguridad'];
      const palette = ['#06D6A0','#118AB2','#FFD166','#8E44AD','#27AE60','#A3A3A3'];
      const baseValuesUSD = keys.map(k => (year1 * (pct[k]||0) / totalPct));
      let labelsOut = [...labels];
      let valuesOut = [...baseValuesUSD];
      let colorsOut = [...palette];
      if (addOverhead){
        const ov = year1 * 0.10; // 10% del subtotal
        labelsOut.push('Overhead (10%)');
        valuesOut.push(ov);
        colorsOut.push('#FF6B6B');
      }
      return { labels: labelsOut, valuesUSD: valuesOut, colors: colorsOut };
    }

    function compute5y(){
      const baseSeries = factors.map(f=> year1 * f);
      if (!addOverhead) return baseSeries;
      return baseSeries.map(v => v * 1.10); // sumar 10%
    }

    function render(){
      // Texto Total Año 1
      const baseY1 = year1;
      const totalY1 = addOverhead ? baseY1 * 1.10 : baseY1;
      qs('#y1total').textContent = fmt(totalY1, currency, trm);

      // Donut
      const bd = getBreakdown();
      const dataVals = bd.valuesUSD.map(v => currency==='USD'?v:v*trm);
      const donutData = { labels: bd.labels, datasets:[{ data: dataVals, backgroundColor: bd.colors, borderColor:'#f8f9fa', borderWidth:2 }] };
      const sharedOpts = { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ color:'#374151', font:{ family:'Inter' } } }, tooltip:{ backgroundColor:'#fff', titleColor:'#111827', bodyColor:'#374151', borderColor:'#E5E7EB', borderWidth:1, padding:10, callbacks:{ label:(ctx)=> `${ctx.label}: ${fmt(ctx.parsed, currency, trm)}` } } } };
      if (donut) donut.destroy();
      donut = new Chart(donutCtx, { type:'doughnut', data:donutData, options:sharedOpts });

      // Línea 5 años
      const y = compute5y().map(v => currency==='USD'?v:v*trm);
      const lineData = { labels:['Año 1','Año 2','Año 3','Año 4','Año 5'], datasets:[{ label:'Presupuesto anual', data:y, fill:false, borderWidth:3, tension:.25 }] };
      const lineOpts = { ...sharedOpts, plugins:{...sharedOpts.plugins, legend:{display:false}}, scales:{ x:{ grid:{display:false}, ticks:{color:'#374151'} }, y:{ grid:{color:'#E5E7EB'}, ticks:{ color:'#374151', callback:(v)=> currency==='USD'?('$'+(v/1e6).toFixed(1)+' M') : ((v/1e9).toFixed(1)+' mil M') } } } };
      if (line) line.destroy();
      line = new Chart(lineCtx, { type:'line', data:lineData, options:lineOpts });
    }

    function apply(){
      currency = qsa('input[name="currency"]').find(i=>i.checked).value;
      trm = parseFloat(qs('#trm').value||'4200');
      year1 = parseFloat(qs('#y1budget').value||'1268000');
      addOverhead = qs('#inclOVR').checked;
      qsa('input[data-pct]').forEach(inp=>{ pct[inp.getAttribute('key')] = parseFloat(inp.value||'0'); });
      factors = (qs('#factors').value||'1,0|1,2|1,3|1,4|1,45').split('|').map(s=> parseFloat(s.replace(',','.')) || 1);
      if (factors.length!==5) factors=[1,1,1,1,1];
      render();
    }

    function downloadCanvas(id, filename){
      const link=document.createElement('a');
      link.download=filename;
      link.href=document.getElementById(id).toDataURL('image/png');
      link.click();
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      render();
      qsa('input[name="currency"]').forEach(r => r.addEventListener('change', apply));
      ['trm','y1budget','factors','inclOVR'].forEach(id=> qs('#'+id).addEventListener('change', apply));
      qsa('input[data-pct]').forEach(inp=> inp.addEventListener('change', apply));
      qs('#apply').addEventListener('click', apply);
      qs('#dl1').addEventListener('click', ()=> downloadCanvas('donut','maci_genetica_y1_desglose.png'));
      qs('#dl2').addEventListener('click', ()=> downloadCanvas('line','maci_genetica_5y_curva.png'));
    });
  </script>
</body>
</html>
